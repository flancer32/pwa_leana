<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Leana Hairdresser Salon.">
    <title>Leana</title>
    <link rel="manifest" href="pwa.webmanifest">
    <script>
        function bootstrap() {
            // load all libraries then create & start application
            Promise.all([
                // keep the order of the imports and params below
                import("./lib/vue_esm_browser.js"),
                import("./lib/vue_router.js"),
                import("./lib/vuex.js"),
                import("./lib/vue-i18next.js"),
                import("./lib/i18next.js"),
                import("./lib/i18nextBrowserLanguageDetector.js"),
            ]).then(async ([modVue, ...other]) => {
                // VueRouter and others are added to 'window' (self) on import
                self.Vue = modVue.default;
                // register Vue Router/Vuex (Router/Vuex are added to globals (window/self) on import)
                self.Vue.use(self.VueRouter);
                self.Vue.use(self.Vuex);
                self.Vue.use(self.VueI18next);
                // create 'app' object in globals
                self.app = {};
                // load frontend configuration and user profile
                const res = await fetch('./api/app/config/get');
                const json = await res.json();
                self.app.config = json.response.config;
                const base = window.location.protocol + '//' + self.app.config.web.urlBase;
                // create and setup DI Container
                const modContainer = await import('./src/@teqfw/di/Container.mjs');
                /** @type {TeqFw_Di_Container} */
                const container = new modContainer.default();
                container.addSourceMapping('Fl32_Leana', base + '/src/mod/leana', true, 'mjs');
                // init i18n
                self.i18next.use(self.i18nextBrowserLanguageDetector).init({
                    detection: {
                        lookupQuerystring: 'lng',
                    },
                });
                await self.i18next.init({
                    lng: 'lv'
                });
                self.i18n = new self.VueI18next(self.i18next);
                // load frontend application
                const appRoot = await container.get('Fl32_Leana_Front_App');
                // create new Vue component (app) and load files with all components starting from root
                self.app.comp = new self.Vue({
                    el: "BODY > DIV",
                    store: new self.Vuex.Store({}),
                    components: {
                        "app_root": appRoot
                    },
                    i18n: self.i18n,
                });
            });
        }

        if ("serviceWorker" in navigator) { // if browser supports service workers
            // ... then add event handler to run script after window will be loaded
            // (https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event)
            self.addEventListener("load", async () => {
                const container = navigator.serviceWorker;
                if (container.controller === null) {
                    // ... to load "sw.js" script and register service worker in navigator
                    try {
                        const reg = await container.register("sw.js");
                        if (reg.active) {
                            console.log("SW is registered and is active.", reg);
                            bootstrap();
                        } else {
                            console.log("SW is registered but is not activated yet.", reg);
                            // wait for `controllerchange` (see `clients.claim()` in SW code on `activate` event)
                            container.addEventListener("controllerchange", () => {
                                // SW just installed (page's first load).
                                bootstrap();
                            });
                        }
                    } catch (e) {
                        console.log("SW registration is failed: ", e)
                    }
                } else {
                    // SW already installed before (repeated loading of the page).
                    console.log("SW is already running for this app.");
                    bootstrap();
                }

            });
        }
    </script>
</head>
<body>
<div style="height: 100%;">
    <app_root></app_root>
</div>
<!--<link rel="stylesheet" href="static/mod/leana/css/styles.css">-->
<link rel="stylesheet" href="css/styles.css">
<!--<link rel="stylesheet" href="fontawesome/css/all.min.css">-->
</body>
</html>
